# トラブルシューティングガイド

## 目次

- [接続に関する問題](#接続に関する問題)
- [表示に関する問題](#表示に関する問題)
- [操作に関する問題](#操作に関する問題)
- [OBSに関する問題](#obsに関する問題)
- [Electron版固有の問題](#electron版固有の問題)
- [パフォーマンスに関する問題](#パフォーマンスに関する問題)
- [ログの確認方法](#ログの確認方法)

## 接続に関する問題

### 🔴 操作パネルに「切断」と表示される

**症状**: ナビゲーションバーに `🔴 切断 (再接続失敗)` と表示される

**原因**:
- サーバーが停止している
- ネットワーク接続に問題がある
- ファイアウォールがWebSocket接続をブロックしている

**対処法**:

1. **サーバーの起動確認**

   Linux/Mac:
   ```bash
   ps aux | grep node
   ```

   Windows:
   ```cmd
   tasklist | findstr node
   ```

   サーバーが起動していない場合:
   ```bash
   node server.js
   ```

2. **ブラウザのリロード**
   - `F5` キーまたは `Ctrl+R` / `Cmd+R` でページをリロード
   - ハードリロード: `Ctrl+Shift+R` / `Cmd+Shift+R`

3. **ネットワーク接続の確認**
   ```bash
   # サーバーへのping確認
   ping localhost  # 同一PC
   ping 192.168.0.10  # 別PC（サーバーのIPアドレス）
   ```

4. **ブラウザの開発者コンソールでエラー確認**
   - `F12` キーで開発者ツールを開く
   - 「Console」タブでエラーメッセージを確認
   - WebSocket関連のエラーがないか確認

5. **ファイアウォールの確認**
   - サーバーPCでポート8080が開放されているか確認
   - 一時的にファイアウォールを無効化してテスト

### 🟡 「再接続中...」から進まない

**症状**: `🟡 再接続中... (10/10)` と表示され、接続できない

**原因**:
- サーバーが完全に停止している
- ネットワーク接続が切断されている
- サーバーのIPアドレスが変わった

**対処法**:

1. **最大試行回数到達後の対処**
   - ページをリロード（`F5`）
   - サーバーの起動を確認してから再度アクセス

2. **サーバーの再起動**
   ```bash
   # サーバーを停止（Ctrl+C）
   # 再起動
   node server.js
   ```

3. **IPアドレスの確認**（マルチPC環境）
   ```bash
   hostname -I  # Linux/Mac
   ipconfig     # Windows
   ```

   IPアドレスが変わっている場合、操作パネルのURLを更新

### WebSocket接続が頻繁に切断される

**症状**: 接続と切断を繰り返す

**原因**:
- ネットワークが不安定
- Wi-Fi接続の電波が弱い
- ルーターの設定問題

**対処法**:

1. **有線LAN接続に変更**
   - Wi-Fiより安定した接続が可能

2. **Wi-Fiチャンネルの変更**
   - 2.4GHz → 5GHz に変更
   - チャンネル混雑を避ける

3. **ルーターの再起動**
   - ルーターを再起動して接続をリフレッシュ

4. **WebSocketタイムアウト設定の調整**（上級者向け）
   - `server.js` のタイムアウト値を調整（デフォルト: 60秒）

## 表示に関する問題

### 操作パネルで変更しても表示ボードに反映されない

**症状**: 得点やイニングを変更しても、表示ボードが更新されない

**原因**:
- WebSocket接続が切断されている
- ブラウザのキャッシュ問題
- 複数タブで操作している（スレーブ状態）

**対処法**:

1. **接続状態の確認**
   - ナビゲーションバーに `🟢 接続中` と表示されているか確認
   - 切断されている場合は前述の接続問題を参照

2. **マスター/スレーブ状態の確認**
   - `👑 マスター (操作可能)` と表示されているか確認
   - `👁️ スレーブ (閲覧専用)` の場合は、マスター権限を取得する必要あり
   - 詳細: [Master/Slave制御](MASTER_SLAVE_ARCHITECTURE.md)

3. **表示ボードのリロード**
   - 表示ボード（board.html）を開いているブラウザで `F5` キー

4. **ブラウザのキャッシュクリア**
   - `Ctrl+Shift+Delete` でキャッシュクリア画面を開く
   - 「キャッシュされた画像とファイル」を選択
   - 「データを削除」

### 表示ボードが真っ白/真っ黒

**症状**: board.html を開いても何も表示されない

**原因**:
- JavaScriptエラー
- サーバーとの接続問題
- ブラウザの互換性問題

**対処法**:

1. **ブラウザの開発者コンソールで確認**
   - `F12` キーで開発者ツールを開く
   - 「Console」タブでエラーメッセージを確認

2. **推奨ブラウザの使用**
   - Chrome、Firefox、Edge の最新版を使用
   - Internet Explorer は非対応

3. **JavaScriptの有効化確認**
   - ブラウザの設定でJavaScriptが有効になっているか確認

4. **サーバーのログ確認**
   - サーバーのコンソール出力でエラーがないか確認

### スコアボードの配置がずれる

**症状**: SVG要素の配置が正しく表示されない

**原因**:
- ブラウザのズーム設定
- CSSの読み込み失敗

**対処法**:

1. **ブラウザのズームをリセット**
   - `Ctrl+0` / `Cmd+0` でズームを100%に戻す

2. **ページのリロード**
   - `Ctrl+Shift+R` / `Cmd+Shift+R` でハードリロード

3. **OBSの解像度設定確認**
   - ブラウザソースの幅・高さが 1920x1080 になっているか確認

## 操作に関する問題

### すべてのボタンが無効化されている

**症状**: 操作パネルのすべてのボタンがクリックできない

**原因**:
- スレーブ状態になっている
- 別のタブまたは別のユーザーがマスター権限を持っている

**対処法**:

1. **マスター/スレーブ表示の確認**
   - `👁️ スレーブ (閲覧専用)` と表示されている場合は、他のユーザーが操作中

2. **マスター権限の取得**

   **方法1: マスターに権限を解放してもらう**
   - マスターユーザーに `🔓 マスター権限を解放` ボタンをクリックしてもらう

   **方法2: マスターの切断を待つ**
   - マスターがタブを閉じて5秒経過すると自動的に昇格

   **方法3: すべてのタブを閉じて再接続**
   - 自分の他のタブをすべて閉じる
   - 新しいタブで操作パネルを開く

3. **接続状態の確認**
   - `🔴 切断` と表示されている場合は、接続問題を先に解決

### 試合をリセットできない

**症状**: 「🔄 試合初期化」ボタンを押しても何も起こらない

**原因**:
- スレーブ状態
- JavaScriptエラー
- 確認ダイアログがブロックされている

**対処法**:

1. **マスター権限の確認**
   - スレーブ状態ではリセットできません
   - マスター権限を取得してから実行

2. **確認ダイアログの確認**
   - ブラウザのポップアップブロックを解除
   - ダイアログが背後に隠れていないか確認

3. **ブラウザのコンソールでエラー確認**
   - `F12` → Console タブでエラーメッセージを確認

### 得点が正しく表示されない

**症状**: 得点を追加しても数値が変わらない、または間違った値になる

**原因**:
- ブラウザのキャッシュ
- データの同期問題

**対処法**:

1. **ページのリロード**
   - `F5` キーでリロード

2. **サーバーの保存データ確認**
   ```bash
   cat data/current_game.json
   ```

   正しいデータが保存されているか確認

3. **試合データの削除と再起動**（最終手段）
   ```bash
   rm data/current_game.json
   node server.js
   ```

## OBSに関する問題

### OBSで表示ボードが表示されない

**症状**: ブラウザソースが真っ白または真っ黒

**原因**:
- URLが間違っている
- OBSのキャッシュ問題
- ネットワーク接続の問題

**対処法**:

1. **URLの確認**
   - ブラウザソースのプロパティを開く
   - URL: `http://localhost:8080/board.html` （または `http://[サーバーIP]:8080/board.html`）
   - ポート番号が正しいか確認

2. **ブラウザでの動作確認**
   - 通常のブラウザで同じURLにアクセスしてみる
   - 表示される場合はOBSの問題、表示されない場合はサーバーの問題

3. **ブラウザソースの再作成**
   - ブラウザソースを削除
   - 新しいブラウザソースを追加

4. **OBSの再起動**
   - OBSを完全に終了して再起動

5. **OBSのログ確認**
   - `ヘルプ` → `ログファイル` → `現在のログファイルを表示`
   - エラーメッセージを確認

### クロマキーが正しく機能しない

**症状**: 背景色が抜けない、またはスコアボードの一部が消える

**原因**:
- クロマキー設定の値が適切でない
- 背景色の設定ミス

**対処法**:

1. **背景色の確認**
   - `config/init_data.json` の `board_background_color` を確認
   - 推奨値: `#00ff00` (グリーン), `#ff00ff` (マゼンタ), `#0000ff` (ブルー)

2. **クロマキー設定の調整**

   **背景が残る場合**:
   - 「類似性」を上げる（400 → 500 → 600）

   **スコアボードが消える場合**:
   - 「類似性」を下げる（400 → 350 → 300）

   **エッジがギザギザの場合**:
   - 「滑らかさ」を上げる（80 → 100 → 120）

3. **キーカラータイプの確認**
   - グリーン背景（`#00ff00`）→ キーカラータイプ: 緑
   - マゼンタ背景（`#ff00ff`）→ キーカラータイプ: マゼンタ
   - ブルー背景（`#0000ff`）→ キーカラータイプ: 青

4. **背景色の変更を試す**
   ```bash
   # グリーンに変更
   npm run init -- -t "テスト" --teams "A,B" --bg-color "#00ff00"
   ```

   サーバーを再起動して board.html をリロード

### OBSでスコアボードの更新が遅い

**症状**: 操作パネルで変更してから数秒後にOBSに反映される

**原因**:
- ネットワーク遅延
- OBSの負荷
- ブラウザソースのフレームレート

**対処法**:

1. **ネットワーク遅延の確認**
   ```bash
   ping localhost  # 同一PC
   ping 192.168.0.10  # 別PC
   ```

   100ms以上の場合はネットワーク環境を改善

2. **OBSのCPU負荷確認**
   - OBSの統計情報でCPU使用率を確認（30%以下が理想）
   - エンコーダー設定を軽くする

3. **ブラウザソースのFPS設定**
   - ブラウザソースのプロパティ → FPS: 30

4. **有線LAN接続への変更**（マルチPC環境）
   - Wi-Fiより遅延が少ない

## Electron版固有の問題

### 開発モードが起動しない（Linux）

**症状**: `npm run electron:dev` を実行するとエラーが発生

```
TypeError: Cannot read properties of undefined (reading 'whenReady')
```

**原因**: 一部のLinux環境でのモジュールロード問題

**対処法**:

1. **Web版で開発**
   ```bash
   node server.js
   ```

2. **AppImageをビルドして実行**
   ```bash
   npm run build:linux
   ./dist/Baseball\ Scoreboard-1.0.0.AppImage --no-sandbox
   ```

3. **別の環境で試行**
   - Windows/macOSでは正常に動作する可能性あり

### AppImageが起動しない（Ubuntu 24.04+）

**症状**: AppImageをダブルクリックしても何も起こらない

**原因**: FUSE2ライブラリが未インストール

**対処法**:

```bash
# FUSE2のインストール
sudo apt install libfuse2

# AppImageの実行
./dist/Baseball\ Scoreboard-1.0.0.AppImage --no-sandbox
```

### 設定ウィンドウが開かない

**症状**: `Ctrl+,` を押しても設定ウィンドウが表示されない

**原因**:
- 設定ウィンドウが既に開いている（背後に隠れている）
- IPCハンドラーのエラー

**対処法**:

1. **既存の設定ウィンドウを確認**
   - `Alt+Tab` で他のウィンドウを確認
   - 設定ウィンドウが開いている場合は閉じてから再度開く

2. **メニューバーから開く**
   - `ファイル > 設定` をクリック

3. **Electronアプリの再起動**
   - アプリを完全に終了（トレイアイコンも終了）
   - 再度起動

### YAMLファイルが読み込めない

**症状**: 設定ウィンドウでYAMLファイルを選択してもエラーが出る

**原因**:
- YAMLの構文エラー
- ファイルの文字エンコーディング問題

**対処法**:

1. **YAML構文の確認**
   - インデントがスペース2個か確認
   - カラーコードが `"#00ff00"` のようにクォートで囲まれているか確認

2. **文字エンコーディングの確認**
   ```bash
   file -bi config/my-config.yaml
   ```

   UTF-8でない場合は変換:
   ```bash
   iconv -f SHIFT_JIS -t UTF-8 config/my-config.yaml > config/my-config-utf8.yaml
   ```

3. **サンプルファイルから開始**
   ```bash
   cp config/config.yaml.example config/my-config.yaml
   ```

## パフォーマンスに関する問題

### ブラウザが重い/遅い

**症状**: 操作パネルや表示ボードの動作が遅い

**原因**:
- ブラウザのメモリ不足
- 拡張機能の干渉
- 古いブラウザバージョン

**対処法**:

1. **ブラウザの再起動**
   - すべてのタブを閉じて再起動

2. **拡張機能の無効化**
   - シークレットモード/プライベートモードで開く
   - 拡張機能が無効化された状態で動作確認

3. **ブラウザのアップデート**
   - 最新版のChrome、Firefox、Edgeにアップデート

4. **メモリの確保**
   - 他のアプリケーションを閉じる
   - 不要なブラウザタブを閉じる

### サーバーのCPU使用率が高い

**症状**: サーバーPCのCPU使用率が100%近くなる

**原因**:
- 接続クライアントが多すぎる
- WebSocketメッセージの大量送信

**対処法**:

1. **不要なクライアントを切断**
   - 使用していないブラウザタブを閉じる

2. **サーバーの再起動**
   ```bash
   # Ctrl+C でサーバーを停止
   node server.js
   ```

3. **ログ出力の無効化**（本番環境）
   ```bash
   NODE_ENV=production node server.js
   ```

## ログの確認方法

### サーバーログの確認

#### 開発モード

サーバーを起動したターミナルに直接表示されます。

```bash
node server.js
```

#### PM2で運用している場合

```bash
# すべてのログ
npm run pm2:logs

# エラーログのみ
cat logs/pm2-error.log

# 標準出力ログ
cat logs/pm2-out.log

# リアルタイムで監視
npm run pm2:logs -- --lines 100
```

### ブラウザのコンソールログ

1. `F12` キーで開発者ツールを開く
2. 「Console」タブを選択
3. エラーメッセージ（赤色）や警告（黄色）を確認

**よくあるエラーメッセージ**:

| エラーメッセージ | 原因 | 対処法 |
|----------------|------|--------|
| `WebSocket connection failed` | サーバーが停止している | サーバーを起動 |
| `Mixed Content` | HTTPSページからHTTP WebSocketに接続 | すべてHTTPまたはHTTPSに統一 |
| `ERR_CONNECTION_REFUSED` | ポート8080が閉じている | ファイアウォール設定を確認 |
| `Unexpected token in JSON` | init_data.jsonの構文エラー | JSONファイルを修正 |

### Electronアプリのログ

#### 開発者ツールの表示

操作パネルまたは表示ボードのウィンドウで:
- `Ctrl+Shift+I` / `Cmd+Option+I` で開発者ツールを開く

#### メインプロセスのログ

Electronアプリを起動したターミナルに表示されます。

```bash
./dist/Baseball\ Scoreboard-1.0.0.AppImage --no-sandbox
```

## さらにサポートが必要な場合

上記の対処法で解決しない場合:

1. **GitHub Issuesで報告**
   - エラーメッセージの全文
   - 再現手順
   - 環境情報（OS、ブラウザ、Node.jsバージョン）

2. **ログファイルの添付**
   - サーバーログ
   - ブラウザのコンソールログ（スクリーンショット）

3. **設定ファイルの確認**
   ```bash
   cat config/init_data.json
   cat data/current_game.json
   ```

## 関連ドキュメント

- [ユーザーガイド](USER_GUIDE.md) - 基本的な使い方
- [マルチPC環境構築](MULTI_PC_SETUP.md) - ネットワーク設定
- [WebSocket再接続](WEBSOCKET_RECONNECTION.md) - 接続問題の詳細
- [Master/Slave制御](MASTER_SLAVE_ARCHITECTURE.md) - 操作権限の詳細
- [本番環境デプロイ](PRODUCTION_DEPLOYMENT.md) - PM2での運用方法
