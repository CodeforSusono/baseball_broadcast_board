# マルチPC環境構築ガイド

## 目次

- [概要](#概要)
- [構成パターン](#構成パターン)
- [ネットワーク設定](#ネットワーク設定)
- [セットアップ手順](#セットアップ手順)
- [OBS設定](#obs設定)
- [トラブルシューティング](#トラブルシューティング)
- [ベストプラクティス](#ベストプラクティス)

## 概要

マルチPC環境では、サーバー・操作・配信を別々のPCで分担することで、より安定した配信環境を構築できます。

### マルチPC環境のメリット

- **配信PCの負荷軽減**: OBSの処理負荷を専用PCに分散
- **操作の独立性**: 配信中でも操作PCで自由に作業可能
- **安定性向上**: 1台がトラブルでも他のPCで継続可能
- **役割分担**: 複数人で操作・配信を分担できる

## 構成パターン

### パターン1: 2PC構成（基本）

```
[操作PC]                    [配信PC]
├── サーバー実行            ├── OBS実行
├── 操作パネル表示          └── 表示ボード表示
└── 192.168.0.10               └── 192.168.0.20
        │                           │
        └───────── LAN ─────────────┘
```

**用途**: 個人配信、小規模イベント

**メリット**: シンプルで設定が簡単

### パターン2: 3PC構成（分離型）

```
[サーバー専用PC]            [操作PC]              [配信PC]
├── サーバー実行のみ        ├── 操作パネル表示    ├── OBS実行
└── 192.168.0.10           └── 192.168.0.11      └── 表示ボード表示
        │                           │                  └── 192.168.0.20
        └───────────────── LAN ─────────────────────────┘
```

**用途**: 大規模イベント、複数試合を同時配信

**メリット**: 各PCの役割が明確、安定性が最も高い

### パターン3: 複数操作PC

```
[サーバーPC]
└── 192.168.0.10
        │
        ├─────── LAN ─────────────┐
        │                         │
[操作PC 1: Master]        [操作PC 2: Slave]
├── 操作パネル（操作可能） ├── 操作パネル（閲覧専用）
└── 192.168.0.11          └── 192.168.0.12
        │
[配信PC]
├── OBS実行
└── 表示ボード表示
    └── 192.168.0.20
```

**用途**: 複数スタッフで運用、交代制の操作

**メリット**: 操作権限を柔軟に切り替え可能

## ネットワーク設定

### IPアドレスの確認

#### サーバーPC（Linux/Mac）

```bash
# 方法1: hostname
hostname -I

# 方法2: ip addr
ip addr show

# 方法3: ifconfig
ifconfig
```

**出力例**:
```
192.168.0.10
```

#### サーバーPC（Windows）

```cmd
ipconfig
```

**出力例**:
```
IPv4 アドレス: 192.168.0.10
```

### IPアドレスの固定化（推奨）

配信中にIPアドレスが変わると接続が切れるため、固定IPを設定することを推奨します。

#### Linux（Ubuntu/Debian）

**NetworkManager使用の場合**:

1. 設定 → ネットワーク → 有線（またはWi-Fi） → 歯車アイコン
2. 「IPv4」タブを選択
3. 「IPv4メソッド」を「手動」に変更
4. 「アドレス」欄に以下を入力:
   - **アドレス**: `192.168.0.10` （任意のIPアドレス）
   - **ネットマスク**: `255.255.255.0`
   - **ゲートウェイ**: `192.168.0.1` （ルーターのIPアドレス）
5. 「DNS」欄に `8.8.8.8` を入力（GoogleのDNS）
6. 「適用」をクリック

#### Windows

1. 設定 → ネットワークとインターネット → イーサネット（またはWi-Fi）
2. 「アダプターのオプションを変更する」をクリック
3. 使用中の接続を右クリック → 「プロパティ」
4. 「インターネット プロトコル バージョン 4 (TCP/IPv4)」を選択 → 「プロパティ」
5. 「次のIPアドレスを使う」を選択し、以下を入力:
   - **IPアドレス**: `192.168.0.10`
   - **サブネットマスク**: `255.255.255.0`
   - **デフォルトゲートウェイ**: `192.168.0.1`
   - **優先DNSサーバー**: `8.8.8.8`
6. 「OK」をクリック

#### macOS

1. システム環境設定 → ネットワーク
2. 使用中の接続を選択 → 「詳細」
3. 「TCP/IP」タブを選択
4. 「IPv4の構成」を「手入力」に変更
5. 以下を入力:
   - **IPv4アドレス**: `192.168.0.10`
   - **サブネットマスク**: `255.255.255.0`
   - **ルーター**: `192.168.0.1`
6. 「OK」→ 「適用」

### ファイアウォール設定

サーバーPCでポート8080を開放する必要があります。

#### Linux（ufw使用の場合）

```bash
# ポート8080を開放
sudo ufw allow 8080/tcp

# 確認
sudo ufw status
```

#### Windows Defender ファイアウォール

1. コントロールパネル → システムとセキュリティ → Windows Defender ファイアウォール
2. 「詳細設定」をクリック
3. 「受信の規則」→ 「新しい規則」
4. 「ポート」を選択 → 「次へ」
5. 「TCP」と「特定のローカルポート」を選択し、`8080` と入力 → 「次へ」
6. 「接続を許可する」→ 「次へ」
7. すべてのプロファイルにチェック → 「次へ」
8. 名前を「Baseball Scoreboard」などに設定 → 「完了」

#### macOS

macOSはデフォルトでファイアウォールが無効です。有効にしている場合:

1. システム環境設定 → セキュリティとプライバシー → ファイアウォール
2. 「ファイアウォールオプション」をクリック
3. 「+」ボタンでNode.jsまたはElectronアプリを追加
4. 「着信接続を許可」を選択

## セットアップ手順

### ステップ1: サーバーPCの準備

#### Web版の場合

1. プロジェクトをインストール
   ```bash
   cd /path/to/baseball_broadcast_board
   npm install
   ```

2. 設定ファイルを生成
   ```bash
   npm run init
   ```

3. サーバーを起動
   ```bash
   node server.js
   ```

4. IPアドレスを確認
   ```bash
   hostname -I
   # 例: 192.168.0.10
   ```

#### Electron版の場合

Electron版は単一PC環境向けのため、マルチPC環境ではWeb版を推奨します。

### ステップ2: 操作PCからアクセス

1. ブラウザを開く（Chrome、Firefox、Edge推奨）

2. 操作パネルにアクセス
   ```
   http://192.168.0.10:8080/operation.html
   ```
   ※ `192.168.0.10` は実際のサーバーPCのIPアドレスに置き換え

3. 接続状態を確認
   - ナビゲーションバーに `🟢 接続中` と表示されることを確認
   - マスター権限を持っていることを確認（`👑 マスター (操作可能)`）

4. 試合設定を確認
   - 大会名、チーム名が正しく表示されているか確認

### ステップ3: 配信PCでOBSを設定

1. OBSを起動

2. ブラウザソースを追加
   - 「ソース」→ 「+」 → 「ブラウザ」
   - 名前: `スコアボード`
   - URL: `http://192.168.0.10:8080/board.html`
   - 幅: `1920`
   - 高さ: `1080`
   - 「ページが読み込まれたときブラウザの表示を更新」にチェック

3. クロマキーフィルタを追加
   - ブラウザソースを右クリック → 「フィルタ」
   - 「エフェクトフィルタ」→ 「+」 → 「クロマキー」
   - キーカラータイプ: 背景色に応じて選択（グリーン、マゼンタ、ブルー）

4. 表示確認
   - OBSのプレビューでスコアボードが正しく表示されることを確認
   - 背景色が正しく抜かれているか確認

### ステップ4: 接続テスト

1. 操作PCで試合状況を更新（例: 得点を追加）

2. 配信PCのOBSプレビューで即座に反映されることを確認

3. 接続が切れた場合の自動再接続を確認
   - サーバーを一時停止 → 再起動
   - 操作パネルに「🟡 再接続中...」と表示されることを確認
   - 自動的に再接続されることを確認

## OBS設定

### ブラウザソースの詳細設定

**推奨設定**:

| 設定項目 | 推奨値 | 説明 |
|---------|--------|------|
| URL | `http://[サーバーIP]:8080/board.html` | サーバーのIPアドレスを指定 |
| 幅 | `1920` | フルHD解像度 |
| 高さ | `1080` | フルHD解像度 |
| FPS | `30` | デフォルトでOK |
| カスタムCSS | 空欄 | 不要 |
| シャットダウン時にブラウザを閉じる | チェック | メモリリーク防止 |
| ページが読み込まれたときブラウザの表示を更新 | チェック | 設定変更時の自動反映 |

### クロマキー設定の最適化

**グリーン背景（`#00ff00`）の場合**:

| 設定項目 | 推奨値 | 調整方法 |
|---------|--------|----------|
| キーカラータイプ | 緑 | - |
| 類似性 | 400-600 | 背景が少し残る場合は上げる |
| 滑らかさ | 80-120 | エッジがギザギザの場合は上げる |
| キーカラー流出低減 | 100 | 緑色の反射がある場合は上げる |

**マゼンタ背景（`#ff00ff`）の場合**:

| 設定項目 | 推奨値 | 調整方法 |
|---------|--------|----------|
| キーカラータイプ | マゼンタ | - |
| 類似性 | 400-600 | 背景が少し残る場合は上げる |
| 滑らかさ | 80-120 | エッジがギザギザの場合は上げる |

### ネットワーク遅延の最小化

**ブラウザソースのキャッシュ無効化**:

ブラウザソースのカスタムCSSに以下を追加（オプション）:

```css
* {
  -webkit-backface-visibility: hidden;
  -webkit-transform: translateZ(0) scale(1.0, 1.0);
}
```

**OBSの優先度設定**（Windows）:

```cmd
# タスクマネージャー → 詳細 → obs64.exe を右クリック → 優先度の設定 → 高
```

## トラブルシューティング

### 操作PCから接続できない

**症状**: 操作パネルにアクセスできない、または `🔴 切断` と表示される

**原因と対処法**:

1. **IPアドレスが間違っている**
   - サーバーPCで `hostname -I` または `ipconfig` を実行して確認
   - ブラウザのURLを修正

2. **ファイアウォールがブロック**
   - サーバーPCでポート8080が開放されているか確認
   - 一時的にファイアウォールを無効化してテスト

3. **サーバーが起動していない**
   - サーバーPCで `ps aux | grep node` （Linux/Mac）
   - サーバーPCで `tasklist | findstr node` （Windows）

4. **異なるネットワークに接続**
   - 両方のPCが同じWi-Fiまたは有線LANに接続されているか確認
   - サーバーPC: `192.168.0.10`、操作PC: `192.168.1.20` のように異なるサブネットの場合は接続不可

### 配信PCでスコアボードが表示されない

**症状**: OBSのブラウザソースが真っ白または真っ黒

**原因と対処法**:

1. **URLが間違っている**
   - ブラウザソースのプロパティを開いて確認
   - 正しいURL: `http://[サーバーIP]:8080/board.html`

2. **OBSのキャッシュ問題**
   - ブラウザソースを削除して再作成
   - OBSを再起動

3. **ネットワーク接続の問題**
   - 配信PCのブラウザで `http://[サーバーIP]:8080/board.html` にアクセスしてテスト
   - 表示される場合はOBSの設定問題、表示されない場合はネットワーク問題

### スコアボードの更新が遅い

**症状**: 操作パネルで変更してから表示ボードに反映されるまで数秒かかる

**原因と対処法**:

1. **ネットワーク遅延**
   - ping でレイテンシを確認
     ```bash
     ping 192.168.0.10
     ```
   - 100ms以上の場合はネットワーク環境を改善

2. **配信PCのCPU負荷**
   - OBSのCPU使用率を確認（30%以下が理想）
   - エンコーダー設定を軽くする（x264 → NVENC など）

3. **Wi-Fi接続の不安定性**
   - 可能であれば有線LAN接続に変更
   - Wi-Fiチャンネルを変更（2.4GHz → 5GHz など）

### 複数の操作PCで同時に操作できない

**症状**: 2台目の操作PCが「👁️ スレーブ (閲覧専用)」になる

**これは正常な動作です**: Master/Slave制御により、最初に接続したPCのみが操作可能です。

**操作権限を切り替える方法**:

1. **マスターが権限を解放**:
   - マスターPCで `🔓 マスター権限を解放` ボタンをクリック
   - 次に古いスレーブPCが自動的にマスターに昇格

2. **マスターを切断**:
   - マスターPCのブラウザを閉じる
   - 5秒後に次のスレーブが自動的にマスターに昇格

詳細: [Master/Slave制御アーキテクチャ](MASTER_SLAVE_ARCHITECTURE.md)

## ベストプラクティス

### ネットワーク構成

- **有線LAN推奨**: Wi-Fiより安定性・速度で優位
- **IPアドレス固定**: DHCPによるIP変更を防止
- **ギガビットスイッチ**: 100Mbpsスイッチは避ける
- **専用ネットワーク**: 可能であれば配信専用のネットワークを構築

### サーバーPC

- **常時起動**: 配信中はサーバーPCを常に起動
- **スリープ無効化**: 省電力設定をオフに
- **バックアップ電源**: UPS（無停電電源装置）の使用を推奨
- **PM2での運用**: 自動再起動・モニタリングを有効化（[本番環境デプロイガイド](PRODUCTION_DEPLOYMENT.md)参照）

### 操作PC

- **予備PCの準備**: トラブル時の交代用PC
- **マスター権限の明確化**: 操作担当者を事前に決定
- **ブラウザのブックマーク**: `http://[サーバーIP]:8080/operation.html` を保存

### 配信PC

- **OBSシーンの準備**: 試合前にすべてのシーンを準備
- **ブラウザソースのテスト**: 本番前に必ず動作確認
- **バックアップ配信**: 予備のストリーミングキーを準備

### 運用フロー

**試合開始前（30分前）**:
- [ ] すべてのPCを起動
- [ ] ネットワーク接続を確認
- [ ] サーバーを起動
- [ ] 操作パネルで接続確認
- [ ] OBSでスコアボード表示確認
- [ ] クロマキー合成のテスト
- [ ] 試合設定の確認（大会名、チーム名）

**試合中**:
- [ ] 操作PCで試合状況を更新
- [ ] 配信PCで表示を定期的に確認
- [ ] 接続状態インジケーターを監視

**試合終了後**:
- [ ] 最終スコアを確認
- [ ] 次の試合の設定を準備
- [ ] 必要に応じて試合データをバックアップ

### セキュリティ

- **パブリックネットワーク禁止**: インターネットに直接公開しない
- **ファイアウォール有効化**: ポート8080以外は閉じる
- **信頼できるネットワークのみ**: 会場の公衆Wi-Fiは使用しない

## 関連ドキュメント

- [ユーザーガイド](USER_GUIDE.md) - 基本的な使い方
- [設定ファイルガイド](CONFIGURATION.md) - 設定方法
- [トラブルシューティング](TROUBLESHOOTING.md) - よくある問題と解決方法
- [本番環境デプロイ](PRODUCTION_DEPLOYMENT.md) - PM2での運用方法
- [WebSocket再接続](WEBSOCKET_RECONNECTION.md) - 接続トラブル時の動作
